<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>离线游戏中心</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{ font-family:-apple-system, BlinkMacSystemFont,'Segoe UI', Roboto,'Helvetica Neue',Arial, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);background-size:cover;background-position: center; background-attachment: fixed; min-height: 100vh; padding: 15px;position:relative;}
.container{max-width:1200px;margin:0 auto;}
header{text-align: center; margin-bottom:15px;color:white;position:relative;}
h1{ font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: fadeInDown 0.8s ease;}
.subtitle{font-size:1.1rem;opacity:0.9;animation:fadeInUp 0.8s ease;}
.user-menu-btn{position:absolute;left:0;top:0;background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 15px;border-radius:20px;cursor:pointer;font-size:14px;transition:all 0.3s ease;display:flex;align-items:center;gap:5px;z-index:1001;}
.user-menu-btn:hover{background:rgba(255,255,255,0.3);}
.user-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover;}
.search-container{ background: rgba(255,255,255,0.95); border-radius:15px; padding:20px; margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);backdrop-filter:blur(10px);animation:slideIn 0.6s ease;}
.search-box{position:relative; max-width:500px; margin:0 auto;}
.search-input{ width: 100%; padding: 15px 50px 15px 20px; border: 2px solid #e0e0e0;border-radius:50px; font-size:16px;transition:all 0.3s ease;background:white;}
.search-input:focus{outline: none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
.search-icon{ position: absolute; right: 20px; top: 50%; transform:translateY(-50%); color:#999; pointer-events: none;}
.games-grid{ display:grid;grid-template-columns: repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-bottom:20px;animation:fadeIn 0.8s ease;}
.game-card{ background: rgba(255,255,255,0.95); border-radius: 15px;padding:20px;text-decoration:none;color:#333;transition:all 0.3s ease; box-shadow:0 5px 15px rgba(0,0,0,0.1); backdrop-filter:blur(10px); position:relative;overflow:hidden;will-change:transform;}
.game-card::before{content:"";position:absolute;top:0; left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2);transform:scaleX(0);transition:transform 0.3s ease;}
.game-card:hover{ transform: translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.2);}
.game-card:hover::before{ transform: scaleX(1);}
.game-number{ display: inline-block; background: linear-gradient(135deg,#667eea,#764ba2);color:white; padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold;margin-bottom:10px;}
.game-card.nav-card{ background: linear-gradient(135deg,#ff9a9e,#fecfef); color:white;}
.game-card.nav-card .game-name{color: white; font-weight: bold;}
.game-card.nav-card .game-number{ background: rgba(255, 255, 255, 0.3); color:white;}
.game-card.tool-card .game-number{ background: linear-gradient(135deg,#f093fb,#f5576c);}
.game-name{ font-size:16px;font-weight:600;color:#333;line-height:1.4;}
.game-card.tool-card .game-name{ color:#f5576c;}
.pagination-wrapper{ display:flex;justify-content:center;align-items:center;gap:8px;margin:20px 0;flex-wrap:wrap;}
.pagination{ display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;}
.pagination button{ padding: 6px 12px; border: none; background:rgba(255,255,255,0.9); color:#667eea; border-radius: 6px; cursor: pointer; font-weight:500; transition: all 0.3s ease; min-width: 32px; font-size: 14px;}
.pagination button:hover:not(:disabled){ background: white; transform: translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,0.15);}
.pagination button.active{ background:linear-gradient(135deg,#667eea,#764ba2); color: white;}
.pagination button:disabled{opacity:0.4; cursor: not-allowed;}
.pagination span{ color: white; font-size: 14px; margin: 0 5px;}
.no-results{text-align:center;color:white;padding:40px;font-size:18px;}
.toast{ position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);background:rgba(102,126,234,0.95); color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.2); opacity:0; transition: all 0.3s ease; z-index:3000; max-width: 80%; text-align: center;}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.secondary-nav-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 36px;
    background: #4CAF50;
    color: black;
    border-radius: 18px;
    text-decoration: none;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
.secondary-nav-btn:hover {
    transform: scale(1.05);
    background: #45a049;
}

/* 侧边栏容器样式 - 70%宽度，覆盖式 */
.sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:1999;opacity:0;visibility:hidden;transition:all 0.3s ease;}
.sidebar-overlay.active{opacity:1;visibility:visible;}
.sidebar-container{position:fixed;top:0;left:-70%;width:70%;height:100%;z-index:2000;transition:all 0.3s ease;box-shadow:2px 0 20px rgba(0,0,0,0.3);}
.sidebar-container.active{left:0;}
#bgInput{display:none;}

@keyframes fadeInDown{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeInUp{ from{ opacity:0;transform:translateY(20px);} to:opacity:1;transform:translateY(0);}}
@keyframes fadeIn{ from{ opacity: 0;} to: opacity:1;}}
@keyframes slideIn{ from{ opacity: 0; transform: translateY(-10px);} to:opacity:1;transform:translateY(0);}}

@media(max-width: 768px){ 
    h1{ font-size: 2rem;}
    .games-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;}
    .sidebar-container{width:80%;left:-80%;}
}
@media(max-width: 480px){
    .games-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;}
    .sidebar-container{width:90%;left:-90%;}
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
<!-- 侧边栏遮罩 -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- 侧边栏容器 -->
<div class="sidebar-container" id="sidebarContainer">
    <iframe id="sidebarFrame" src="sidebar.html" style="width:100%;height:100%;border:none;"></iframe>
</div>

<input type="file" id="bgInput" accept="image/*" onchange="handleBgUpload(event)">
<div id="toast" class="toast"></div>

<div class="container">
<header>
<button class="user-menu-btn" onclick="openSidebar()">
<img id="headerUserAvatar" class="user-avatar" src="https://picsum.photos/seed/default-avatar/24/24.jpg" alt="用户头像">
<span>用户中心</span>
</button>
<h1>离线游戏中心</h1>
</header>
<div class="search-container">
<div class="search-box">
<input type="text" class="search-input" id="searchInput" placeholder="搜索游戏名称...">
<span class="search-icon"><i class="fas fa-search"></i></span>
</div>
</div>
<main>
<div class="games-grid" id="gamesGrid"></div>
<div class="pagination-wrapper" id="paginationWrapper">
    <div class="pagination" id="pagination"></div>
</div>
</main>
<div style="margin-top:8px;font-size:12px;color:#666;text-align:center;">联系邮箱：1660396635@qq.com</div>
</div>
<script src="config.js"></script>
<script>
let currentPage = 1;
const gamesPerPage = 16;
let allGames = [];
let filteredGames = [];
let isLoading = false;

// 使用文档片段优化DOM操作
function createGameCard(game, globalIndex) {
    const isNav = game.category === 'navigation';
    const isTool = game.category === 'tools';
    
    const card = document.createElement('a');
    card.href = game.file;
    card.className = `game-card ${isNav ? 'nav-card' : ''} ${isTool ? 'tool-card' : ''}`;
    
    card.innerHTML = `
        <span class="game-number">#${globalIndex}</span>
        <div class="game-name">${game.name}</div>
    `;
    
    return card;
}

function initGames(){
    try {
        allGames = window.gameConfig.getAllGames();
        filteredGames = [...allGames];
        currentPage = 1;
        renderGames();
        renderPagination();
        loadUserAvatar();
    } catch (error) {
        console.error('游戏加载失败:', error);
        showToast('游戏加载失败，请刷新页面重试');
    }
}

function renderGames(){
    if (isLoading) return;
    isLoading = true;
    
    const gamesGrid = document.getElementById('gamesGrid');
    const startIndex = (currentPage - 1) * gamesPerPage;
    const endIndex = startIndex + gamesPerPage;
    const gamesToShow = filteredGames.slice(startIndex, endIndex);
    
    if (gamesToShow.length === 0) {
        gamesGrid.innerHTML = '<div class="no-results">没有找到匹配的游戏</div>';
        isLoading = false;
        return;
    }
    
    // 使用文档片段优化性能
    const fragment = document.createDocumentFragment();
    
    gamesToShow.forEach((game, index) => {
        const globalIndex = startIndex + index + 1;
        const card = createGameCard(game, globalIndex);
        fragment.appendChild(card);
    });
    
    gamesGrid.innerHTML = '';
    gamesGrid.appendChild(fragment);
    
    isLoading = false;
}

function renderPagination(){
    const pagination = document.getElementById('pagination');
    const wrapper = document.getElementById('paginationWrapper');
    const totalPages = Math.ceil(filteredGames.length / gamesPerPage);
    
    if (totalPages <= 1) {
        wrapper.innerHTML = "";
        return;
    }
    
    let paginationHTML = "";
    
    paginationHTML += `<button onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>‹</button>`;
    
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button onclick="changePage(1)">1</button>`;
        if (startPage > 2) paginationHTML += `<span>...</span>`;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<button onclick="changePage(${i})" class="${i===currentPage?'active':''}">${i}</button>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) paginationHTML += `<span>...</span>`;
        paginationHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
    }
    
    paginationHTML += `<button onclick="changePage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>›</button>`;
    
    paginationHTML += `<a href="${window.gameConfig.secondaryNav.file}" class="secondary-nav-btn" title="${window.gameConfig.secondaryNav.title}">${window.gameConfig.secondaryNav.name}</a>`;
    
    pagination.innerHTML = paginationHTML;
}

function changePage(page){
    const totalPages = Math.ceil(filteredGames.length / gamesPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderGames();
        renderPagination();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
}

// 防抖搜索
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchTerm = e.target.value.toLowerCase().trim();
        if (searchTerm === "") {
            filteredGames = [...allGames];
        } else {
            filteredGames = allGames.filter(game => 
                game.name.toLowerCase().includes(searchTerm)
            );
        }
        currentPage = 1;
        renderGames();
        renderPagination();
    }, 300);
});

// 侧边栏控制
function openSidebar() {
    document.getElementById('sidebarContainer').classList.add('active');
    document.getElementById('sidebarOverlay').classList.add('active');
    
    // 通知侧边栏更新用户数据
    setTimeout(() => {
        const iframe = document.getElementById('sidebarFrame');
        if (iframe.contentWindow && iframe.contentWindow.updateUserData) {
            iframe.contentWindow.updateUserData();
        }
    }, 100);
}

function closeSidebar() {
    document.getElementById('sidebarContainer').classList.remove('active');
    document.getElementById('sidebarOverlay').classList.remove('active');
}

// 加载用户头像
function loadUserAvatar() {
    const savedAvatar = localStorage.getItem('userAvatar');
    if (savedAvatar) {
        document.getElementById('headerUserAvatar').src = savedAvatar;
    }
}

// Toast提示
function showToast(message, duration = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}

// 背景上传
function handleBgUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showToast('请选择有效的图片文件');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showToast('图片大小不能超过5MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        localStorage.setItem('pageBackground', e.target.result);
        localStorage.setItem('bgTimestamp', Date.now().toString());
        document.body.style.backgroundImage = `url(${e.target.result})`;
        showToast('背景更换成功!');
    };
    reader.readAsDataURL(file);
    event.target.value = "";
}

function loadSavedBackground() {
    const savedBg = localStorage.getItem('pageBackground');
    const timestamp = localStorage.getItem('bgTimestamp');
    if (savedBg && timestamp) {
        const age = Date.now() - parseInt(timestamp);
        if (age < 7 * 24 * 60 * 60 * 1000) {
            document.body.style.backgroundImage = `url(${savedBg})`;
        } else {
            localStorage.removeItem('pageBackground');
            localStorage.removeItem('bgTimestamp');
        }
    }
}

// 监听来自侧边栏的消息
window.addEventListener('message', function(event) {
    if (event.data.type === 'closeSidebar') {
        closeSidebar();
    } else if (event.data.type === 'showToast') {
        showToast(event.data.message);
    } else if (event.data.type === 'updateAvatar') {
        document.getElementById('headerUserAvatar').src = event.data.avatar;
    } else if (event.data.type === 'changeBackground') {
        document.getElementById('bgInput').click();
    }
});

// ESC键关闭侧边栏
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSidebar();
    }
});

// 页面加载时初始化
window.addEventListener('load', function() {
    initGames();
    loadSavedBackground();
});
</script>
</body>
</html>
