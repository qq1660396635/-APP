<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>ShellBrowser Â· çœŸæ ¸å®ç”¨æµè§ˆå™¨</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;font:14px/1.4 -apple-system,BlinkMacSystemFont;overflow:hidden}
  #toolbar{display:flex;align-items:center;background:#f5f5f5;border-bottom:1px solid #ddd;padding:6px}
  #url{flex:1;padding:6px 8px;border:1px solid #ccc;border-radius:4px;margin:0 6px}
  button{padding:6px 10px;margin:0 2px;border:1px solid #bbb;border-radius:4px;background:#fff;cursor:pointer}
  button:hover{background:#e6e6e6}
  #webview{height:calc(100vh - 41px);width:100%}
  /* è¯„è®ºæµ®å±‚ */
  #commentBar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ddd;max-height:260px;display:flex;flex-direction:column;z-index:9999}
  #commentBar.hidden{display:none}
  #commentHead{padding:6px 10px;background:#fafafa;font-size:12px;color:#666}
  #commentList{flex:1;overflow:auto;padding:6px 10px;font-size:13px}
  #commentInputWrap{display:flex;padding:6px 10px;border-top:1px solid #eee}
  #commentInput{flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;margin-right:6px}
  /* è§†é¢‘å°çª— */
  #videoPop{position:fixed;top:20px;right:20px;width:360px;height:202px;background:#000;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,.6);z-index:10000;display:none}
  #videoPop video{width:100%;height:100%;border-radius:8px}
  /* å‘å¸ƒæŒ‰é’® */
  #fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:#e91e63;color:#fff;border:none;font-size:24px;box-shadow:0 2px 8px rgba(233,30,99,.4);z-index:9999}
  /* ä¸‹è½½é¢æ¿ */
  #downPanel{position:fixed;bottom:40px;left:20px;width:260px;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.15);padding:10px;font-size:12px;display:none;z-index:9999}
  #downPanel .title{font-weight:bold;margin-bottom:6px}
  #downPanel .item{margin:4px 0;display:flex;justify-content:space-between}
  #downPanel progress{width:100%}
  /* è´­ä¹°ä¾§æ  */
  #buyBar{position:fixed;top:0;right:-320px;width:300px;height:100%;background:#fff;box-shadow:-2px 0 8px rgba(0,0,0,.1);transition:right .3s;z-index:9999;display:flex;flex-direction:column}
  #buyBar.show{right:0}
  #buyHead{padding:10px;border-bottom:1px solid #eee;font-weight:bold}
  #buyFrame{flex:1;border:none}
</style>
</head>
<body>
<div id="toolbar">
  <button id="back">â†</button>
  <button id="forward">â†’</button>
  <button id="reload">â†»</button>
  <input id="url" placeholder="è¾“å…¥ç½‘å€å›è½¦">
  <button id="go">å‰å¾€</button>
</div>

<!-- WebView2 çœŸæ ¸ -->
<iframe id="webview" src="https://www.bilibili.com"></iframe>

<!-- è¯„è®ºæ  -->
<div id="commentBar" class="hidden">
  <div id="commentHead">ğŸ’¬ å½“å‰é¡µé¢è¯„è®ºï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰</div>
  <div id="commentList"></div>
  <div id="commentInputWrap">
    <input id="commentInput" placeholder="å†™ç‚¹ä»€ä¹ˆâ€¦">
    <button id="commentSend">å‘é€</button>
  </div>
</div>

<!-- è§†é¢‘å°çª— -->
<div id="videoPop"><video controls></video></div>

<!-- å‘å¸ƒ FAB -->
<button id="fab">+</button>

<!-- ä¸‹è½½é¢æ¿ -->
<div id="downPanel">
  <div class="title">ğŸ“¥ ä¸‹è½½ç®¡ç†</div>
  <div id="downList"></div>
</div>

<!-- è´­ä¹°ä¾§æ  -->
<div id="buyBar">
  <div id="buyHead">ğŸ” æ¯”ä»·åŠ©æ‰‹</div>
  <iframe id="buyFrame" src="about:blank"></iframe>
</div>

<script>
/* ========== å·¥å…·å‡½æ•° ========== */
const $ = q => document.querySelector(q);
const webview = $('#webview');
const commentBar = $('#commentBar');
const videoPop = $('#videoPop');
const downPanel = $('#downPanel');
const buyBar = $('#buyBar');

/* ========== 1. åœ°å€æ å¯¼èˆª ========== */
function nav(){
  let u = $('#url').value.trim();
  if(!u.startsWith('http')) u = 'https://' + u;
  webview.src = u;
}
$('#go').onclick = $('#url').onkeydown = e => { if(e.key==='Enter') nav(); };
$('#back').onclick    = () => webview.contentWindow.history.back();
$('#forward').onclick = () => webview.contentWindow.history.forward();
$('#reload').onclick  = () => webview.contentWindow.location.reload();
webview.onload = () => {
  $('#url').value = webview.contentWindow.location.href;
  loadComment();          // è½½å…¥è¯„è®º
  detectVideo();          // æ£€æµ‹è§†é¢‘
  detectShop();           // æ£€æµ‹ç”µå•†
};

/* ========== 2. è¯„è®ºç³»ç»Ÿï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰ ========== */
const COMMENT_KEY = 'shellBrowser_comment';
function loadComment(){
  const url = webview.contentWindow.location.href;
  const all = JSON.parse(localStorage.getItem(COMMENT_KEY)||'{}');
  const arr = all[url] || [];
  $('#commentList').innerHTML = arr.map(c=>
    `<div style="margin:4px 0"><b>${c.time}</b> ${c.text}</div>`).join('');
  commentBar.classList.remove('hidden');
}
$('#commentSend').onclick = ()=>{
  const txt = $('#commentInput').value.trim();
  if(!txt) return;
  const url = webview.contentWindow.location.href;
  const all = JSON.parse(localStorage.getItem(COMMENT_KEY)||'{}');
  if(!all[url]) all[url]=[];
  all[url].push({text:txt, time:new Date().toLocaleTimeString()});
  localStorage.setItem(COMMENT_KEY, JSON.stringify(all));
  $('#commentInput').value='';
  loadComment();
};

/* ========== 3. è§†é¢‘å°çª— ========== */
function detectVideo(){
  const doc = webview.contentDocument || webview.contentWindow.document;
  const v = doc.querySelector('video');
  if(v){
    const popVid = videoPop.querySelector('video');
    popVid.src = v.src || v.currentSrc;
    videoPop.style.display='block';
    v.addEventListener('play', ()=>popVid.play());
    v.addEventListener('pause',()=>popVid.pause());
  }else{
    videoPop.style.display='none';
  }
}

/* ========== 4. ä¸‹è½½æ‹¦æˆª ========== */
webview.addEventListener('load', ()=>{
  const doc = webview.contentDocument || webview.contentWindow.document;
  // æ‹¦æˆª <a download>
  doc.addEventListener('click', e=>{
    const a = e.target.closest('a[download]');
    if(a && a.href){
      e.preventDefault();
      startDownload(a.href, a.download||'unknown');
    }
  });
  // æ‹¦æˆªèµ„æºè¯·æ±‚
  const origOpen = doc.XMLHttpRequest.prototype.open;
  doc.XMLHttpRequest.prototype.open = function(m,u){
    if(m.toLowerCase()==='get' && (u.includes('.zip')||u.includes('.exe')||u.includes('.mp4'))){
      startDownload(u);
    }
    return origOpen.apply(this, arguments);
  };
});

function startDownload(url, filename='æœªçŸ¥æ–‡ä»¶'){
  downPanel.style.display='block';
  const id = Date.now();
  const item = document.createElement('div');
  item.className='item';
  item.innerHTML = `
    <span>${filename}</span>
    <progress value="0" max="100"></progress>
  `;
  $('#downList').appendChild(item);
  // ä½¿ç”¨ fetch æµå¼ä¸‹è½½
  fetch(url).then(r=>{
    const len = r.headers.get('content-length');
    let loaded=0;
    const reader = r.body.getReader();
    const stream = new ReadableStream({
      start(ctrl){
        function pump(){
          reader.read().then(({done, value})=>{
            if(done){ ctrl.close(); return; }
            loaded += value.byteLength;
            item.querySelector('progress').value = Math.round(loaded/len*100);
            ctrl.enqueue(value);
            pump();
          });
        }
        pump();
      }
    });
    return new Response(stream).blob();
  }).then(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    item.innerHTML += '<span style=color:green> âœ“å®Œæˆ</span>';
  }).catch(err=>{
    item.innerHTML += '<span style=color:red> âœ—å¤±è´¥</span>';
  });
}

/* ========== 5. å‘å¸ƒç³»ç»Ÿ ========== */
$('#fab').onclick = ()=>{
  const type = prompt('å‘å¸ƒç±»å‹ï¼š1 å›¾æ–‡  2 æ–‡ä»¶  3 ä»£ç ç‰‡æ®µ');
  if(!type) return;
  if(type==='1'){
    const title = prompt('æ ‡é¢˜');
    const body  = prompt('å†…å®¹');
    if(title&&body) alert('å·²å‘å¸ƒåˆ°æœ¬åœ°å­˜å‚¨ï¼\næ ‡é¢˜ï¼š'+title+'\nå†…å®¹ï¼š'+body);
    // å®é™…å¯ POST åˆ°è‡ªå»ºæ¥å£ / GitHub Issues ç­‰
  }else if(type==='2'){
    const input = document.createElement('input');
    input.type='file';
    input.onchange = e=>{
      const f = e.target.files[0];
      alert('å·²é€‰æ‹©æ–‡ä»¶ï¼š'+f.name+'\nå¤§å°ï¼š'+(f.size/1024/1024).toFixed(2)+' MB\nå¯ç»§ç»­è°ƒç”¨ä¸Šä¼  API');
    };
    input.click();
  }else if(type==='3'){
    const code = prompt('ç²˜è´´ä»£ç ');
    if(code) alert('å·²ä¿å­˜ä»£ç ç‰‡æ®µåˆ°æœ¬åœ°ï¼\n'+code);
  }
};

/* ========== 6. è´­ä¹°åŠ©æ‰‹ ========== */
function detectShop(){
  const href = webview.contentWindow.location.href;
  const shopList = ['tb.cn','tmall.com','jd.com','kaola.com','yangkeduo.com','suning.com'];
  const isShop = shopList.some(d=>href.includes(d));
  if(isShop){
    buyBar.classList.add('show');
    // ç®€å•ç¤ºä¾‹ï¼šæŠŠå½“å‰å•†å“æ ‡é¢˜ä¸¢åˆ°æ¯”ä»·ç½‘ç«™
    const doc = webview.contentDocument || webview.contentWindow.document;
    const title = doc.title;
    $('#buyFrame').src = `https://www.manmanbuy.com/search.aspx?keyword=${encodeURIComponent(title)}`;
  }else{
    buyBar.classList.remove('show');
  }
}
</script>
</body>
</html>
