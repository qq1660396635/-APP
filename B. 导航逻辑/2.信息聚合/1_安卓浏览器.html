<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的收藏</title>
    <script src="cordova.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            flex-wrap: wrap;
            gap: 10px;
        }
        h1 {
            color: #333;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        /* 默认：一行两个卡片*/
        .cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .link-card {
            background: linear-gradient(145deg, #f3f4f6, #ffffff);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        .link-card:hover {
            transform: translateY(-3px);
        }
        .link-card:nth-child(3n+1) {
            background: linear-gradient(145deg, #e8f5e9, #ffffff);
        }
        .link-card:nth-child(3n+2) {
            background: linear-gradient(145deg, #fff3e0, #ffffff);
        }
        .link-card:nth-child(3n+3) {
            background: linear-gradient(145deg, #fce4ec, #ffffff);
        }
        .link-card h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            margin: 0;
            font-size: 1.1em;
        }
        .link-card:nth-child(3n+1) h3 {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }
        .link-card:nth-child(3n+2) h3 {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        }
        .link-card:nth-child(3n+3) h3 {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }
        /* 卡片内容：始终保持两列*/
        .card-content {
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .link-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .link-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .link-item:active {
            transform: scale(0.98);
        }
        .link-card:nth-child(3n+1) .link-item {
            border-left: 3px solid #4caf50;
        }
        .link-card:nth-child(3n+2) .link-item {
            border-left: 3px solid #ff9800;
        }
        .link-card:nth-child(3n+3) .link-item {
            border-left: 3px solid #e91e63;
        }
        .link-number {
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .link-card:nth-child(3n+1) .link-number {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }
        .link-card:nth-child(3n+2) .link-number {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        }
        .link-card:nth-child(3n+3) .link-number {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }
        .link-text {
            color: #333;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.85em;
            font-weight: 500;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.85em;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.9);
            border-radius: 6px;
            font-size: 0.8em;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 8px;
            margin: 10px 0;
        }
        /* 分页导航样式*/
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
        }
        .page-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        .page-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .page-btn:active {
            transform: scale(0.95);
        }
        .page-btn.active {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .page-info {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        /* 隐私页面按钮样式*/
        .privacy-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        .privacy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
        }
        .privacy-btn:active {
            transform: scale(0.95);
        }
        /* 密码弹窗样式*/
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .password-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
            width: 350px;
        }
        .password-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .password-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        .password-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .password-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .password-confirm {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }
        .password-cancel {
            background: #f5f5f5;
            color: #666;
        }
        .password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .password-error {
            color: #d32f2f;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }
        /* 返回按钮样式*/
        .back-button {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .back-button:active {
            transform: scale(0.95);
        }
        /* 加载指示器*/
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            justify-content: center;
            align-items: center;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 移动端优化：卡片单列，但内容保持两列*/
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; border-radius: 8px; }
            .cards-container { grid-template-columns: 1fr; gap: 10px; }
            .card-content { grid-template-columns: 1fr 1fr; gap: 6px; }
            .header { flex-direction: column; align-items: stretch; }
            h1 { font-size: 1.3em; text-align: center; }
            .link-item { padding: 6px; }
            .link-text { font-size: 0.8em; }
            .link-number { width: 20px; height: 20px; font-size: 11px; margin-right: 6px; }
            .back-button { top: 10px; left: 10px; padding: 8px 16px; font-size: 14px; }
            .pagination { padding: 10px; gap: 8px; }
            .page-btn { padding: 6px 12px; font-size: 12px; }
            .page-info { font-size: 12px; }
            .privacy-btn { padding: 6px 12px; font-size: 12px; }
            .password-content { padding: 20px; width: 90%; max-width: 300px; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.2em; }
            .link-card h3 { font-size: 1em; padding: 10px; }
            .card-content { padding: 8px; gap: 4px; }
            .link-item { padding: 5px; }
            .link-text { font-size: 0.75em; }
            .link-number { width: 18px; height: 18px; font-size: 10px; margin-right: 5px; }
        }
    </style>
</head>
<body>
    <!-- 返回按钮-->
    <button class="back-button" id="backButton">←返回收藏</button>
    
    <!-- 加载指示器-->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- 密码验证弹窗-->
    <div class="password-modal" id="passwordModal">
        <div class="password-content">
            <div class="password-title">隐私页面</div>
            <input type="password" class="password-input" id="passwordInput" placeholder="请输入密码" maxlength="10">
            <div class="password-buttons">
                <button class="password-btn password-confirm" onclick="checkPassword()">确认</button>
                <button class="password-btn password-cancel" onclick="closePasswordModal()">取消</button>
            </div>
            <div class="password-error" id="passwordError">密码错误，请重试</div>
        </div>
    </div>
    
    <div class="container">
        <div class="status-bar">
            <span id="deviceStatus">设备准备中...</span>
            <span id="updateTime">-</span>
        </div>
        <div class="header">
            <h1 id="mainTitle">我的收藏</h1>
        </div>
        <div class="cards-container" id="content">
            <div class="loading">正在加载收藏内容...</div>
        </div>
        <!-- 分页导航-->
        <div class="pagination" id="pagination">
            <button class="page-btn" id="prevBtn" onclick="changePage(-1)">上一页</button>
            <span class="page-info" id="pageInfo">第 1 页 / 共 3 页</span>
            <button class="page-btn" id="nextBtn" onclick="changePage(1)">下一页</button>
            <button class="privacy-btn" onclick="showPasswordModal()">隐私</button>
        </div>
        <div class="footer">
            <p>在应用内打开链接</p>
        </div>
    </div>
    
<script>
// ===== 永不调用的加密脚本字符串 =====
const encryptionScript = `#!/usr/bin/env bash
# enc.sh - 强制UTF-8编码的加密脚本
read -rp "待加密的多行文本（Ctrl-D 结束输入）：" -d '' RAW
# 1. Base64编码（强制UTF-8）
B64=$(printf '%s' "$RAW" | base64 -w0)
# 2. 乱序：每4字符一组倒序
SHUFF=$(printf '%s' "$B64" | sed 's/....\|$/&\\n/g' | tac | tr -d '\\n')
printf '\\n--- 已加密，可直接复制到源码 ---\\n'
printf '%s\\n' "$SHUFF"`;

// ===== 前两页保持明文，第三页加密 =====
// 第一页收藏数据（明文）
const page1Data = `===收藏===
===通用与隐私搜索===
1. Google | https://www.google.com
2. Bing | https://www.bing.com
3. Yahoo | https://search.yahoo.com
4. DuckDuckGo | https://duckduckgo.com
5. Yandex | https://yandex.com
6. Startpage | https://www.startpage.com
===新兴与特色搜索===
7. Ecosia | https://www.ecosia.org
8. Qwant | https://www.qwant.com
9. Brave Search | https://search.brave.com
10. Swisscows | https://swisscows.com
11. Mojeek | https://www.mojeek.com
12. You.com | https://you.com
===区域化与AI 对话搜索===
13. Perplexity | https://www.perplexity.ai
14. Naver | https://www.naver.com
15. Yahoo!JAPAN | https://www.yahoo.co.jp
16. WolframAlpha | https://www.wolframalpha.com
17. GitHub Search | https://github.com/search`;

// 第二页收藏数据（明文）
const page2Data = `===收藏===
===日常轻玩===
1. Poki 游戏| https://poki.com/zh/g/hills-of-steel#fullscreen
2. C 语言手册| https://www.matools.com/doc/c/h_stdio.htm
3. 在线工具| https://tool.lu/c/text/
4. 树图思维导图| https://m.shutu.cn/
5. 免费游戏平台| https://game.ilovefree.com/?category=最近上新
===AI-Bug 治理工具===
6. Stack Overflow | https://stackoverflow.com
7. 菜鸟教程| https://www.runoob.com
8. CSDN 社区| https://www.csdn.net
9. 博客园| https://www.cnblogs.com
===知识库（文档·论文·书籍）===
10. CORE 学术库| https://core.ac.uk/?sharetype=link
11. 计算机工程| https://www.ecice06.com/CN/1000-3428/home.shtml
12. 电赛Wiki | https://www.micu.wiki/documents
13. 电 赛 培 训 | https://www.nuedc-training.com.cn/mobile/search/search_bbs/w/2025
14. 立创开源硬件| https://oshwhub.com/
15. 鑫峰资源库| https://link3.cc/xfzlk?channel=1
===厂商文档===
16. 黑马嵌入式文档| https://www.yuque.com/icheima/vzsofu
17. RK3308 Wiki | https://wiki.t-firefly.com/ROC-RK3308-CC/
18. STM32F103 文 档 | https://www.stmcu.com.cn/Mobile/pro_detail/cat_code/STM32F103/family/81/layout/product
===常用工具===
19. 破解| https://www.52pojie.cn/
20. AI 提示词库| https://www.aishort.top/
21. 工具站| https://tool.lu/mermaid/`;

// 第三页隐私数据（加密）- 使用新的UTF-8强制加密方法
const page3DataEncrypted = 'dG1sLnNoOTQzODk4YXkvZHBsL3ZvbmV0aXMuaHRoYXRjLy9jcHM6aHR0IHwgq5ggLiDpCjE2ICAgb20vMC5jaTUyaW1laW1lLy9hcHM6aHR0IHwg5aa56JCdNS4gMgoxZ2U9JnBh5aupcmQ9eXdvP2tlcmNoc2VhZXgvaW5kaWMvY29tY2MvZmguY21hLm5pNmNjLy9kcHM6aHR0IHwgn5G6cCDwIDkxMTQuICAKY2gvZWFycC9zLnRvbzAyL3lhczovdHRwfCBon5G6sr7wppbnLiDlCjEzPT0956uZ54m5r40vlK7ohbPpwrfl6Imy54m55Zu95LitPT09MwoKZTU3ZTZjcy83c3NldHJlL2FjL2Nub25lMjMuYXYxaXNzLy9tcHM6aHR0IHwgc2F2bWlzLiAgCjEydGVyL2VudG9wdHYubGUtamFiOi8vdHBzIGh0uiB88J+RbGUgamFiLiAgCjExPT09SkFWrMK3peacPeaXCj09YmEKeWJvaW5uL3NrZGVsL21vY29tdWIucm5oLnBvL2NuczovdHRwfCBodWIgcm5oIHBvMTAudTgKLm0zZGV4L2luMTAzLzg3MDAwLzg3ZW9zdmlkdHMvdGVuY29uY2MvZWkuYWl3amItdHQuL2J5czovdHRwfCBonLogmo/mLiDpPQo5iD09muWQiOiBvOWQt+e7pJbCm73lPT3lCgo9byAgN292cHlfcHVwZXI6LXVzbC9xLWFsaC90YXJjL3NlZXdzZC5uL2JhczovdHRwfCBod3MgLm5lYmVkOC4gICAKb20vZS5jbm9kb25zLy9tcHM6aHR0IHwg54m55o6oNy4gICAKdmxtZGF0cGFuL3MvLm1lLy90cHM6aHR0IHwg54yr54aKibkujqjnLiDmPQo2iD09muWQpeiBteaKt+eUpJbCm73lPT3lCgo9ayAgcz1qb3JkZXl3aD9rYXJjL3NlY29tMDAuc2UxLnFpMG8xcmZkOi8vdHBzIGh0MSB8LiA5IAo1bWwgLmh0OTI1MzU3ZW8vdmlkb20vdi5jbGlhLm1pd3d3Oi8vdHBzIGh0kiB8s+eyIOexCjQugSAgOOWyeT0xP2tldG1saC5oYXJjL3NlZW9zdmlkOTcvMzg4MTc6NDkuNS4yOC44Ly8zcHM6aHR0IHwg5bKb5oOF54ixMy4gICAKLyAgaG9wOC5zaWUyc2VqOi8vdHBzIGh0IHwgn5G6iCDwmuWQIOiBCjEuPT0956uZ6aKR6KeGvcK3reWbPeS4Cj09PT095pOO5byV57Si5pCc55So5bi45Zu95LitPT09'; // 实际需用enc.sh生成

// ===== 解密函数（基于Base64编码原理） =====
function decrypt(enc) {
  // Base64编码原理：每6位二进制数据表示一个字符[7,8](@ref)
  // 解密逻辑：先反转乱序，再进行Base64解码
  const b64 = enc.match(/.{1,4}/g).reverse().join('');
  
  // Base64解码（支持UTF-8）
  try {
    // 使用TextDecoder确保UTF-8编码[1](@ref)
    const decoder = new TextDecoder('utf-8');
    const byteString = atob(b64);
    const bytes = new Uint8Array(byteString.length);
    
    for (let i = 0; i < byteString.length; i++) {
      bytes[i] = byteString.charCodeAt(i);
    }
    
    return decoder.decode(bytes);
  } catch (e) {
    console.error('解密失败:', e);
    return '解密错误，请检查数据格式';
  }
}

// ===== 全局变量 =====
let currentPage = 1; // 当前页码
const totalPages = 3; // 总页数
let currentView = 'home'; // 'home' 或'external'
let inAppBrowserRef = null;
let isPage3Unlocked = false; // 第三页是否已解锁
let page3DecryptedData = null; // 存储解密后的第三页数据

// ===== Cordova 设备就绪事件 =====
document.addEventListener('deviceready', onDeviceReady, false);

function onDeviceReady() {
  console.log('Cordova 设备已就绪');
  document.getElementById('deviceStatus').textContent = '设备就绪 ';
  
  // 设置返回按钮事件
  document.getElementById('backButton').addEventListener('click', goBackToHome);
  
  // 初始化第一页
  loadPage(1);
  updateTimestamp();
  
  // 监听返回键（Android）
  document.addEventListener('backbutton', handleBackButton, false);
}

function handleBackButton() {
  if (currentView === 'external' && inAppBrowserRef) {
    goBackToHome();
  } else {
    // 退出应用或最小化
    navigator.app.exitApp();
  }
}

function goBackToHome() {
  if (inAppBrowserRef) {
    inAppBrowserRef.close();
    inAppBrowserRef = null;
  }
  
  // 显示收藏页面
  document.getElementById('content').style.display = 'grid';
  document.getElementById('pagination').style.display = 'flex';
  document.getElementById('backButton').style.display = 'none';
  document.querySelector('.header').style.display = 'flex';
  document.querySelector('.footer').style.display = 'block';
  document.querySelector('.status-bar').style.display = 'flex';
  
  currentView = 'home';
  document.title = '我的收藏';
}

// ===== 修改后的loadPage函数 =====
function loadPage(pageNum) {
  // 如果是第三页且未解锁，不加载
  if (pageNum === 3 && !isPage3Unlocked) {
    return;
  }
  
  // 更新当前页码
  currentPage = pageNum;
  
  let dataText;
  
  // 前两页直接使用明文，第三页需要解密
  if (pageNum === 1) {
    dataText = page1Data;
  } else if (pageNum === 2) {
    dataText = page2Data;
  } else if (pageNum === 3) {
    // 如果已经解密过，直接使用存储的数据
    if (page3DecryptedData) {
      dataText = page3DecryptedData;
    } else {
      // 解密第三页数据但不立即显示
      try {
        page3DecryptedData = decrypt(page3DataEncrypted);
        dataText = page3DecryptedData;
      } catch (e) {
        console.error('解密第三页数据失败:', e);
        dataText = '===收藏===\n===加密数据===\n解密失败，请检查密码或数据完整性';
      }
    }
  }
  
  // 解析并渲染数据
  const data = parseLinksData(dataText);
  renderLinks(data);
  
  // 更新分页导航状态
  updatePaginationUI();
}

function changePage(direction) {
  const newPage = currentPage + direction;
  
  // 如果要访问第三页且未解锁，显示密码输入框
  if (newPage === 3 && !isPage3Unlocked) {
    showPasswordModal();
    return;
  }
  
  // 检查页码范围
  if (newPage >= 1 && newPage <= totalPages) {
    // 添加页面切换动画
    const content = document.getElementById('content');
    content.style.opacity = '0';
    content.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      loadPage(newPage);
      content.style.transition = 'all 0.3s ease';
      content.style.opacity = '1';
      content.style.transform = 'translateY(0)';
    }, 200);
  }
}

function updatePaginationUI() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');
  
  // 更新按钮状态
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage === totalPages;
  
  // 更新页码信息
  pageInfo.textContent = `第${currentPage} 页/ 共${totalPages} 页 `;
  
  // 更新按钮样式
  if (currentPage === 1) {
    prevBtn.classList.remove('active');
  } else {
    prevBtn.classList.add('active');
  }
  
  if (currentPage === totalPages) {
    nextBtn.classList.remove('active');
  } else {
    nextBtn.classList.add('active');
  }
}

function showPasswordModal() {
  document.getElementById('passwordModal').style.display = 'flex';
  document.getElementById('passwordInput').value = '';
  document.getElementById('passwordError').style.display = 'none';
  document.getElementById('passwordInput').focus();
}

function closePasswordModal() {
  document.getElementById('passwordModal').style.display = 'none';
}

function checkPassword() {
  const password = document.getElementById('passwordInput').value;
  
  if (password === '2025') {
    isPage3Unlocked = true;
    closePasswordModal();
    // 密码正确后，现在可以显示第三页了
    loadPage(3);
    updatePaginationUI();
  } else {
    document.getElementById('passwordError').style.display = 'block';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
  }
}

// ===== 数据解析和渲染函数（保持不变） =====
function parseLinksData(text) {
  const lines = text.split('\n').filter(line => line.trim());
  
  if (lines.length === 0) {
    return { mainTitle: "我的收藏", groups: [] };
  }
  
  const data = {
    mainTitle: lines[0],
    groups: []
  };
  
  let currentGroup = null;
  
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.startsWith('===') && line.endsWith('===')) {
      if (currentGroup && currentGroup.links.length > 0) {
        data.groups.push(currentGroup);
      }
      currentGroup = {
        title: line.substring(3, line.length - 3),
        links: []
      };
    } else if (currentGroup !== null) {
      const linkMatch = line.match(/(\d+)\.\s*(.+?)\s*\|\s*(https?:\/\/[^\s]+)/);
      if (linkMatch) {
        currentGroup.links.push({
          number: parseInt(linkMatch[1], 10),
          name: linkMatch[2].trim(),
          url: linkMatch[3].trim()
        });
      }
    }
  }
  
  if (currentGroup && currentGroup.links.length > 0) {
    data.groups.push(currentGroup);
  }
  
  return data;
}

function renderLinks(data) {
  const mainTitleEl = document.getElementById('mainTitle');
  if (mainTitleEl) {
    mainTitleEl.textContent = data.mainTitle;
  }
  document.title = data.mainTitle;
  
  const contentDiv = document.getElementById('content');
  
  if (data.groups.length === 0) {
    contentDiv.innerHTML = '<div class="error">没有找到可显示的网站链接</div>';
    return;
  }
  
  let cardsHtml = '';
  data.groups.forEach(group => {
    cardsHtml += `
      <div class="link-card">
        <h3>${group.title}</h3>
        <div class="card-content">
          ${createLinksHtml(group.links)}
        </div>
      </div>
    `;
  });
  
  contentDiv.innerHTML = cardsHtml;
  
  // 添加点击事件监听
  addLinkClickListeners();
  animateLinks();
}

function createLinksHtml(links) {
  let leftColumnHtml = '';
  let rightColumnHtml = '';
  
  const midPoint = Math.ceil(links.length / 2);
  const leftLinks = links.slice(0, midPoint);
  const rightLinks = links.slice(midPoint);
  
  leftLinks.forEach(link => {
    leftColumnHtml += `
      <div class="link-item" data-url="${link.url}">
        <span class="link-number">${link.number}</span>
        <span class="link-text">${link.name}</span>
      </div>
    `;
  });
  
  rightLinks.forEach(link => {
    rightColumnHtml += `
      <div class="link-item" data-url="${link.url}">
        <span class="link-number">${link.number}</span>
        <span class="link-text">${link.name}</span>
      </div>
    `;
  });
  
  return `
    <div class="link-column">${leftColumnHtml}</div>
    <div class="link-column">${rightColumnHtml}</div>
  `;
}

function addLinkClickListeners() {
  const linkItems = document.querySelectorAll('.link-item');
  linkItems.forEach(item => {
    item.addEventListener('click', function() {
      const url = this.getAttribute('data-url');
      openLinkInApp(url);
    });
  });
}

function openLinkInApp(url) {
  // 显示加载指示器
  document.getElementById('loadingOverlay').style.display = 'flex';
  
  if (typeof cordova !== 'undefined' && cordova.InAppBrowser) {
    // 使用InAppBrowser在当前WebView中打开链接
    const options = 'location=yes,toolbar=yes,hardwareback=yes,zoom=yes,closebuttoncaption=返回';
    
    // 创建新的InAppBrowser实例
    inAppBrowserRef = cordova.InAppBrowser.open(url, '_blank', options);
    
    // 监听加载事件
    inAppBrowserRef.addEventListener('loadstart', function() {
      console.log('页面开始加载: ' + url);
    });
    
    inAppBrowserRef.addEventListener('loadstop', function() {
      console.log('页面加载完成');
      // 隐藏加载指示器
      document.getElementById('loadingOverlay').style.display = 'none';
      
      // 更新页面状态
      currentView = 'external';
      document.getElementById('backButton').style.display = 'block';
    });
    
    inAppBrowserRef.addEventListener('loaderror', function(params) {
      console.log('页面加载错误: ' + params.message);
      document.getElementById('loadingOverlay').style.display = 'none';
      alert('页面加载失败，请检查网络连接');
    });
    
    inAppBrowserRef.addEventListener('exit', function() {
      console.log('浏览器已关闭');
      goBackToHome();
    });
  } else {
    // 备用方案：使用普通浏览器打开
    document.getElementById('loadingOverlay').style.display = 'none';
    window.open(url, '_system');
  }
}

function animateLinks() {
  const links = document.querySelectorAll('.link-item');
  links.forEach((link, index) => {
    link.style.opacity = '0';
    link.style.transform = 'translateX(-20px)';
    
    setTimeout(() => {
      link.style.transition = 'all 0.5s ease';
      link.style.opacity = '1';
      link.style.transform = 'translateX(0)';
    }, index * 30);
  });
}

function updateTimestamp() {
  const now = new Date();
  const timeString = now.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  const updateTimeEl = document.getElementById('updateTime');
  if (updateTimeEl) {
    updateTimeEl.textContent = timeString;
  }
}

// 如果Cordova未加载，直接渲染（用于浏览器测试）
if (typeof cordova === 'undefined') {
  console.log('Cordova未加载，直接渲染页面');
  loadPage(1);
  updateTimestamp();
}

// 浏览器中的备用点击处理
document.addEventListener('click', function(e) {
  const linkItem = e.target.closest('.link-item');
  if (linkItem) {
    const url = linkItem.getAttribute('data-url');
    window.open(url, '_blank');
  }
});

// 支持回车键提交密码
document.getElementById('passwordInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkPassword();
  }
});
</script>
