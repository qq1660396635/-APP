<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­å›½å†›æ£‹ - æ ‡å‡†è§„åˆ™ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        /* èƒŒæ™¯æ¸å˜æ ·å¼ */
        .bg-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .bg-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .bg-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .bg-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .bg-gradient-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .bg-gradient-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .bg-gradient-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .bg-gradient-9 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .bg-gradient-10 { background: linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%); }
        .bg-gradient-11 { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .bg-gradient-12 { background: linear-gradient(135deg, #f83600 0%, #f9d423 100%); }
        .bg-gradient-13 { background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%); }
        .bg-gradient-14 { background: linear-gradient(135deg, #5f72bd 0%, #9b23ea 100%); }
        .bg-gradient-15 { background: linear-gradient(135deg, #2af598 0%, #009efd 100%); }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            width: 100%;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
            to { text-shadow: 2px 2px 20px rgba(255,255,255,0.5); }
        }

        .bg-selector {
            position: absolute;
            top: 0;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .bg-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            margin: 2px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .bg-btn:hover {
            transform: scale(1.2);
        }

        .game-mode {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .mode-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: scale(1.05);
        }

        .game-info {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .current-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-indicator {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .player1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .player2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .ai {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
        }

        .inactive {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .score {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            color: #666;
        }

        .board-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 0 auto;
            position: relative;
        }

        .river {
            position: absolute;
            left: -15px;
            right: -15px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4facfe, #00f2fe, #4facfe, transparent);
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
            box-shadow: 0 0 10px rgba(79,172,254,0.5);
        }

        .river::before {
            content: 'ç•Œæ²³';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -10px;
            background: rgba(255,255,255,0.9);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: #4facfe;
            font-weight: bold;
        }

        .cell {
            aspect-ratio: 1;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 2;
        }

        .cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .cell.camp {
            background: linear-gradient(135deg, #90EE90 0%, #98FB98 100%);
            border-color: #228B22;
            position: relative;
        }

        .cell.camp::before {
            content: 'è¥';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: #228B22;
            font-weight: bold;
        }

        .cell.headquarters {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-color: #FF8C00;
            position: relative;
        }

        .cell.headquarters::before {
            content: 'å¸';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: #8B4513;
            font-weight: bold;
        }

        .cell.river-side {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .cell.forbidden {
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0,
                #f0f0f0 5px,
                #e0e0e0 5px,
                #e0e0e0 10px
            );
            border-color: #999;
            cursor: not-allowed;
        }

        .piece {
            width: 90%;
            height: 90%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }

        .piece.hidden {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 20px;
        }

        .piece.hidden::after {
            content: '?';
        }

        .piece.player1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 2px 5px rgba(245,87,108,0.4);
        }

        .piece.player2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 2px 5px rgba(79,172,254,0.4);
        }

        .piece.selected {
            animation: pulse 1s infinite;
            box-shadow: 0 0 20px rgba(255,215,0,0.8);
            transform: scale(1.1);
        }

        @keyframes pulse {
            0% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1.1); }
        }

        .piece.can-move {
            animation: glow 1s infinite;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,215,0,0.8); }
            100% { box-shadow: 0 0 5px rgba(255,215,0,0.5); }
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .message.show {
            display: block;
        }

        .message h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .message p {
            color: #666;
            margin-bottom: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .rules {
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            max-width: 400px;
            width: 100%;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .rules h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .rules ul {
            margin-left: 20px;
        }

        .ai-thinking {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: #666;
            z-index: 10;
            display: none;
            animation: thinking 1s infinite;
        }

        @keyframes thinking {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .ai-thinking.show {
            display: block;
        }

        @media (max-width: 380px) {
            .board {
                gap: 5px;
            }
            
            .piece {
                font-size: 12px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body class="bg-gradient-1">
    <div class="header">
        <h1>âš”ï¸ ä¸­å›½å†›æ£‹ âš”ï¸</h1>
        <div class="bg-selector">
            <button class="bg-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="changeBackground(1)"></button>
            <button class="bg-btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="changeBackground(2)"></button>
            <button class="bg-btn" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="changeBackground(3)"></button>
            <button class="bg-btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="changeBackground(4)"></button>
            <button class="bg-btn" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="changeBackground(5)"></button>
        </div>
    </div>

    <div class="game-mode">
        <button class="mode-btn active" onclick="game.setMode('pvp')">åŒäººå¯¹æˆ˜</button>
        <button class="mode-btn" onclick="game.setMode('ai')">äººæœºå¯¹æˆ˜</button>
    </div>

    <div class="game-info">
        <div class="current-player">
            <span>å½“å‰å›åˆï¼š</span>
            <div class="player-indicator player1" id="currentPlayer">ç©å®¶1</div>
        </div>
        <div class="score">
            <div>ç©å®¶1å‰©ä½™: <span id="player1Count">25</span> æš</div>
            <div id="player2Label">ç©å®¶2å‰©ä½™: <span id="player2Count">25</span> æš</div>
        </div>
    </div>

    <div class="board-container">
        <div class="river"></div>
        <div class="ai-thinking" id="aiThinking">AIæ€è€ƒä¸­...</div>
        <div class="board" id="board"></div>
    </div>

    <div class="controls">
        <button class="btn" onclick="game.restart()">é‡æ–°å¼€å§‹</button>
        <button class="btn" onclick="game.showRules()">æ¸¸æˆè§„åˆ™</button>
        <button class="btn" onclick="game.undo()">æ‚”æ£‹</button>
    </div>

    <div class="rules" id="rulesPanel" style="display: none;">
        <h3>ğŸ“– æ ‡å‡†å†›æ£‹è§„åˆ™</h3>
        <ul>
            <li><strong>æ£‹å­ç­‰çº§ï¼š</strong>å¸ä»¤>å†›é•¿>å¸ˆé•¿>æ—…é•¿>å›¢é•¿>è¥é•¿>è¿é•¿>æ’é•¿>å·¥å…µ</li>
            <li><strong>ç‚¸å¼¹ï¼š</strong>å¯ä¸ä»»ä½•æ£‹å­åŒå½’äºå°½ï¼ŒåŒ…æ‹¬åœ°é›·</li>
            <li><strong>åœ°é›·ï¼š</strong>ä¸èƒ½ç§»åŠ¨ï¼Œå·¥å…µå¯æŒ–ï¼Œç‚¸å¼¹å¯ç‚¸</li>
            <li><strong>å†›æ——ï¼š</strong>ä¸èƒ½ç§»åŠ¨ï¼Œè¢«åƒæ‰å³è¾“</li>
            <li><strong>è¡Œè¥ï¼š</strong>å®‰å…¨åŒºï¼Œåˆå§‹ä¸èƒ½æ”¾æ£‹ï¼Œè¿›å…¥åä¸è¢«åƒ</li>
            <li><strong>å¤§æœ¬è¥ï¼š</strong>å†›æ——å¿…é¡»æ”¾åœ¨å¤§æœ¬è¥ï¼Œè¿›å…¥åä¸èƒ½ç§»åŠ¨</li>
            <li><strong>ç•Œæ²³ï¼š</strong>æ£‹å­ä¸èƒ½è·¨è¶Šç•Œæ²³</li>
            <li><strong>è·èƒœï¼š</strong>åƒæ‰å¯¹æ–¹å†›æ——æˆ–å¯¹æ–¹æ— æ£‹å¯èµ°</li>
        </ul>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="message" id="message">
        <h2 id="messageTitle">æ¸¸æˆç»“æŸ</h2>
        <p id="messageText">ç©å®¶1è·èƒœï¼</p>
        <button class="btn" onclick="game.hideMessage()">ç¡®å®š</button>
    </div>

    <script>
        class MilitaryChess {
            constructor() {
                this.board = [];
                this.currentPlayer = 1;
                this.selectedPiece = null;
                this.gameOver = false;
                this.mode = 'pvp';
                this.history = [];
                this.pieces = this.createPieces();
                this.init();
            }

            createPieces() {
                const types = [
                    { name: 'å¸ä»¤', count: 1, power: 9 },
                    { name: 'å†›é•¿', count: 1, power: 8 },
                    { name: 'å¸ˆé•¿', count: 2, power: 7 },
                    { name: 'æ—…é•¿', count: 2, power: 6 },
                    { name: 'å›¢é•¿', count: 2, power: 5 },
                    { name: 'è¥é•¿', count: 2, power: 4 },
                    { name: 'è¿é•¿', count: 3, power: 3 },
                    { name: 'æ’é•¿', count: 3, power: 2 },
                    { name: 'å·¥å…µ', count: 3, power: 1 },
                    { name: 'ç‚¸å¼¹', count: 2, power: 10 },
                    { name: 'åœ°é›·', count: 3, power: 0 },
                    { name: 'å†›æ——', count: 1, power: -1 }
                ];

                let pieces = [];
                for (let player = 1; player <= 2; player++) {
                    for (let type of types) {
                        for (let i = 0; i < type.count; i++) {
                            pieces.push({
                                name: type.name,
                                power: type.power,
                                player: player,
                                revealed: false
                            });
                        }
                    }
                }
                return this.shuffle(pieces);
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // å®šä¹‰è¡Œè¥ä½ç½®ï¼ˆä¸èƒ½æ”¾æ£‹ï¼‰
            isCamp(row, col) {
                return (row === 2 || row === 3 || row === 6 || row === 7) && (col === 1 || col === 3);
            }

            // å®šä¹‰å¤§æœ¬è¥ä½ç½®
            isHeadquarters(row, col) {
                return (row === 0 || row === 9) && (col === 1 || col === 3);
            }

            init() {
                this.board = [];
                let pieceIndex = 0;
                
                for (let row = 0; row < 10; row++) {
                    this.board[row] = [];
                    for (let col = 0; col < 5; col++) {
                        // è¡Œè¥ä½ç½®ä¸æ”¾æ£‹å­
                        if (this.isCamp(row, col)) {
                            this.board[row][col] = null;
                        } else if (pieceIndex < this.pieces.length) {
                            this.board[row][col] = this.pieces[pieceIndex++];
                        } else {
                            this.board[row][col] = null;
                        }
                    }
                }
                this.render();
                this.updateUI();
            }

            render() {
                const boardElement = document.getElementById('board');
                boardElement.innerHTML = '';
                
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 5; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        
                        // ç•Œæ²³ä¸¤ä¾§çš„ç‰¹æ®Šæ ·å¼
                        if (row === 4 || row === 5) {
                            cell.classList.add('river-side');
                        }
                        
                        // ç‰¹æ®Šä½ç½®æ ‡è®°
                        if (this.isCamp(row, col)) {
                            cell.classList.add('camp');
                        } else if (this.isHeadquarters(row, col)) {
                            cell.classList.add('headquarters');
                        }
                        
                        const piece = this.board[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.className = 'piece';
                            
                            if (piece.revealed) {
                                pieceElement.classList.add(`player${piece.player}`);
                                pieceElement.textContent = piece.name;
                            } else {
                                pieceElement.classList.add('hidden');
                            }
                            
                            cell.appendChild(pieceElement);
                        }
                        
                        cell.addEventListener('click', () => this.handleCellClick(row, col));
                        boardElement.appendChild(cell);
                    }
                }
            }

            handleCellClick(row, col) {
                if (this.gameOver) return;
                if (this.mode === 'ai' && this.currentPlayer === 2) return;
                
                const piece = this.board[row][col];
                
                if (!piece) {
                    // ç©ºæ ¼å­ï¼Œå°è¯•ç§»åŠ¨
                    if (this.selectedPiece) {
                        this.movePiece(this.selectedPiece.row, this.selectedPiece.col, row, col);
                    }
                } else if (!piece.revealed) {
                    // ç¿»æ£‹
                    this.revealPiece(row, col);
                } else if (piece.player === this.currentPlayer) {
                    // é€‰æ‹©å·±æ–¹æ£‹å­
                    if (this.canMove(piece, row, col)) {
                        this.selectPiece(row, col);
                    }
                } else if (this.selectedPiece) {
                    // åƒå­
                    this.movePiece(this.selectedPiece.row, this.selectedPiece.col, row, col);
                }
            }

            canMove(piece, row, col) {
                // åœ°é›·å’Œå†›æ——ä¸èƒ½ç§»åŠ¨
                if (piece.power === 0 || piece.power === -1) return false;
                return true;
            }

            selectPiece(row, col) {
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                document.querySelectorAll('.piece.selected').forEach(p => {
                    p.classList.remove('selected');
                });
                document.querySelectorAll('.piece.can-move').forEach(p => {
                    p.classList.remove('can-move');
                });
                
                this.selectedPiece = { row, col };
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"] .piece`);
                if (cell) {
                    cell.classList.add('selected');
                }
                
                // é«˜äº®å¯ç§»åŠ¨çš„ä½ç½®
                this.highlightMovablePositions(row, col);
            }

            highlightMovablePositions(row, col) {
                const directions = [[-1,0], [1,0], [0,-1], [0,1]];
                for (let [dr, dc] of directions) {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    if (this.isValidMove(row, col, newRow, newCol)) {
                        const cell = document.querySelector(`[data-row="${newRow}"][data-col="${newCol}"] .piece`);
                        if (cell) {
                            cell.classList.add('can-move');
                        }
                    }
                }
            }

            isValidMove(fromRow, fromCol, toRow, toCol) {
                if (toRow < 0 || toRow >= 10 || toCol < 0 || toCol >= 5) return false;
                
                // ä¸èƒ½è·¨è¶Šç•Œæ²³
                if ((fromRow === 4 && toRow === 5) || (fromRow === 5 && toRow === 4)) {
                    return false;
                }
                
                const fromPiece = this.board[fromRow][fromCol];
                const toPiece = this.board[toRow][toCol];
                
                if (!toPiece) return true;
                if (toPiece.player === fromPiece.player) return false;
                if (!toPiece.revealed) return false;
                
                return true;
            }

            revealPiece(row, col) {
                const piece = this.board[row][col];
                if (piece && !piece.revealed) {
                    piece.revealed = true;
                    this.render();
                    this.switchPlayer();
                }
            }

            movePiece(fromRow, fromCol, toRow, toCol) {
                if (!this.isValidMove(fromRow, fromCol, toRow, toCol)) return;
                
                // ä¿å­˜å†å²è®°å½•
                this.history.push({
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol },
                    piece: this.board[fromRow][fromCol],
                    captured: this.board[toRow][toCol],
                    player: this.currentPlayer
                });
                
                const fromPiece = this.board[fromRow][fromCol];
                const toPiece = this.board[toRow][toCol];
                
                if (toPiece) {
                    const result = this.battle(fromPiece, toPiece);
                    if (result === 'win') {
                        this.board[toRow][toCol] = fromPiece;
                        this.board[fromRow][fromCol] = null;
                        
                        if (toPiece.power === -1) {
                            this.endGame(fromPiece.player);
                        }
                    } else if (result === 'lose') {
                        this.board[fromRow][fromCol] = null;
                        
                        if (fromPiece.power === -1) {
                            this.endGame(toPiece.player);
                        }
                    } else {
                        // åŒå½’äºå°½
                        this.board[fromRow][fromCol] = null;
                        this.board[toRow][toCol] = null;
                    }
                } else {
                    this.board[toRow][toCol] = fromPiece;
                    this.board[fromRow][fromCol] = null;
                }
                
                this.selectedPiece = null;
                this.render();
                this.updateUI();
                this.switchPlayer();
            }

            battle(attacker, defender) {
                // ä¿®æ­£çš„ç‚¸å¼¹è§„åˆ™ï¼šç‚¸å¼¹ä¸åœ°é›·åŒå½’äºå°½
                if (attacker.power === 10 || defender.power === 10) {
                    return 'draw';
                }
                
                // å·¥å…µæŒ–åœ°é›·
                if (attacker.power === 1 && defender.power === 0) {
                    return 'win';
                }
                
                // åœ°é›·ç‚¸æ­»å…¶ä»–æ£‹å­ï¼ˆé™¤ç‚¸å¼¹å’Œå·¥å…µï¼‰
                if (defender.power === 0) {
                    return 'lose';
                }
                
                // æ™®é€šå¯¹æˆ˜
                if (attacker.power > defender.power) {
                    return 'win';
                } else if (attacker.power < defender.power) {
                    return 'lose';
                } else {
                    return 'draw';
                }
            }

            switchPlayer() {
                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                this.updateUI();
                
                // AIå›åˆ
                if (this.mode === 'ai' && this.currentPlayer === 2 && !this.gameOver) {
                    setTimeout(() => this.aiMove(), 1000);
                }
            }

            aiMove() {
                const aiThinking = document.getElementById('aiThinking');
                aiThinking.classList.add('show');
                
                setTimeout(() => {
                    const moves = this.getValidAIMoves();
                    if (moves.length > 0) {
                        const move = moves[Math.floor(Math.random() * moves.length)];
                        
                        if (move.type === 'reveal') {
                            this.revealPiece(move.row, move.col);
                        } else {
                            this.movePiece(move.from.row, move.from.col, move.to.row, move.to.col);
                        }
                    }
                    aiThinking.classList.remove('show');
                }, 500);
            }

            getValidAIMoves() {
                const moves = [];
                
                // ç¿»æ£‹
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 5; col++) {
                        const piece = this.board[row][col];
                        if (piece && !piece.revealed && piece.player === 2) {
                            moves.push({ type: 'reveal', row, col });
                        }
                    }
                }
                
                // ç§»åŠ¨å’Œåƒå­
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 5; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.revealed && piece.player === 2 && this.canMove(piece, row, col)) {
                            const directions = [[-1,0], [1,0], [0,-1], [0,1]];
                            for (let [dr, dc] of directions) {
                                const newRow = row + dr;
                                const newCol = col + dc;
                                if (this.isValidMove(row, col, newRow, newCol)) {
                                    moves.push({
                                        type: 'move',
                                        from: { row, col },
                                        to: { row: newRow, col: newCol }
                                    });
                                }
                            }
                        }
                    }
                }
                
                return moves;
            }

            updateUI() {
                const playerIndicator = document.getElementById('currentPlayer');
                const player2Label = document.getElementById('player2Label');
                
                if (this.mode === 'ai') {
                    playerIndicator.textContent = this.currentPlayer === 1 ? 'ç©å®¶' : 'AI';
                    playerIndicator.className = `player-indicator ${this.currentPlayer === 1 ? 'player1' : 'ai'}`;
                    player2Label.innerHTML = 'AIå‰©ä½™: <span id="player2Count">25</span> æš';
                } else {
                    playerIndicator.textContent = `ç©å®¶${this.currentPlayer}`;
                    playerIndicator.className = `player-indicator player${this.currentPlayer}`;
                    player2Label.innerHTML = 'ç©å®¶2å‰©ä½™: <span id="player2Count">25</span> æš';
                }
                
                // æ›´æ–°å‰©ä½™æ£‹å­æ•°
                let player1Count = 0, player2Count = 0;
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 5; col++) {
                        const piece = this.board[row][col];
                        if (piece) {
                            if (piece.player === 1) player1Count++;
                            else player2Count++;
                        }
                    }
                }
                document.getElementById('player1Count').textContent = player1Count;
                document.getElementById('player2Count').textContent = player2Count;
            }

            setMode(mode) {
                this.mode = mode;
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                this.restart();
            }

            undo() {
                if (this.history.length === 0) return;
                
                const lastMove = this.history.pop();
                this.board[lastMove.from.row][lastMove.from.col] = lastMove.piece;
                this.board[lastMove.to.row][lastMove.to.col] = lastMove.captured;
                
                this.currentPlayer = lastMove.player;
                this.selectedPiece = null;
                this.render();
                this.updateUI();
            }

            endGame(winner) {
                this.gameOver = true;
                const winnerName = this.mode === 'ai' ? 
                    (winner === 1 ? 'ç©å®¶' : 'AI') : 
                    `ç©å®¶${winner}`;
                this.showMessage('æ¸¸æˆç»“æŸ', `${winnerName}è·èƒœï¼`);
            }

            showMessage(title, text) {
                document.getElementById('messageTitle').textContent = title;
                document.getElementById('messageText').textContent = text;
                document.getElementById('message').classList.add('show');
                document.getElementById('overlay').classList.add('show');
            }

            hideMessage() {
                document.getElementById('message').classList.remove('show');
                document.getElementById('overlay').classList.remove('show');
            }

            showRules() {
                const rulesPanel = document.getElementById('rulesPanel');
                rulesPanel.style.display = rulesPanel.style.display === 'none' ? 'block' : 'none';
            }

            restart() {
                this.currentPlayer = 1;
                this.selectedPiece = null;
                this.gameOver = false;
                this.history = [];
                this.pieces = this.createPieces();
                this.init();
            }
        }

        const game = new MilitaryChess();

        function changeBackground(bgNumber) {
            document.body.className = `bg-gradient-${bgNumber}`;
        }
    </script>
</body>
</html>
