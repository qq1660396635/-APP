<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>第一人称3D迷宫 - 移动优化版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }
        
        #info {
            top: 10px;
            left: 10px;
            text-align: center;
        }
        
        #minimap {
            top: 10px;
            right: 10px;
            width: 80px;
            height: 80px;
            padding: 4px;
            pointer-events: none;
        }
        
        #minimap canvas {
            width: 100%;
            height: 100%;
        }
        
        #touch-controls {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #movement-controls {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            gap: 6px;
        }
        
        .touch-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            user-select: none;
            touch-action: manipulation;
        }
        
        .touch-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }
        
        #btn-up { grid-area: up; }
        #btn-left { grid-area: left; }
        #btn-down { grid-area: down; }
        #btn-right { grid-area: right; }
        
        #camera-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .success {
            color: #4ade80;
            font-weight: bold;
        }
        
        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            z-index: 100;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
            max-width: 80%;
        }
        
        #start-message {
            display: block;
        }
        
        #win-message {
            color: #4ade80;
        }
        
        .compass {
            position: absolute;
            top: 70px;
            left: 10px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }
        
        #fps {
            position: absolute;
            bottom: 80px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
        }
        
        @media (max-height: 500px) {
            .touch-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            #minimap {
                width: 70px;
                height: 70px;
            }
            
            .ui-panel {
                font-size: 10px;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 350px) {
            .touch-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            #minimap {
                width: 60px;
                height: 60px;
            }
            
            #touch-controls {
                padding: 0 10px;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="info" class="ui-panel">
            <div>位置: <span id="position">(1,1)</span> | 方向: <span id="direction">北</span></div>
            <div id="status">探索迷宫中...</div>
        </div>
        
        <div class="compass" id="compass">N</div>
        
        <div id="minimap" class="ui-panel">
            <canvas id="minimapCanvas"></canvas>
        </div>
        
        <div id="fps">FPS: <span id="fps-value">0</span></div>
        
        <div id="touch-controls">
            <div class="control-group">
                <div id="movement-controls">
                    <div class="touch-btn" id="btn-up">↑</div>
                    <div class="touch-btn" id="btn-left">←</div>
                    <div class="touch-btn" id="btn-down">↓</div>
                    <div class="touch-btn" id="btn-right">→</div>
                </div>
                <div style="color: white; font-size: 10px; margin-top: 5px;">移动</div>
            </div>
            
            <div class="control-group">
                <div id="camera-controls">
                    <div class="touch-btn" id="btn-turn-left">↶</div>
                    <div class="touch-btn" id="btn-turn-right">↷</div>
                </div>
                <div style="color: white; font-size: 10px; margin-top: 5px;">转向</div>
            </div>
        </div>
        
        <div id="start-message" class="message">
            <h2>第一人称3D迷宫</h2>
            <p>找到绿色标记的出口即可获胜</p>
            <p>使用方向键移动，转向键调整视角</p>
            <p>触摸任意按钮开始游戏</p>
        </div>
        
        <div id="win-message" class="message">
            <h2>恭喜你赢了!</h2>
            <p>你成功找到了迷宫的出口</p>
            <p>3秒后自动开始新游戏</p>
        </div>
    </div>

    <script>
        // 获取Canvas元素
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimapCanvas');
        const minimapCtx = minimapCanvas.getContext('2d');
        
        // UI元素
        const positionElement = document.getElementById('position');
        const directionElement = document.getElementById('direction');
        const statusElement = document.getElementById('status');
        const compassElement = document.getElementById('compass');
        const fpsElement = document.getElementById('fps-value');
        const startMessage = document.getElementById('start-message');
        const winMessage = document.getElementById('win-message');
        
        // 性能优化变量
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;
        
        // 调整画布大小以适应屏幕
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            minimapCanvas.width = 80;
            minimapCanvas.height = 80;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // 迷宫参数 - 优化为7x7以提高性能
        const mazeSize = 7;
        let maze = [];
        let player = {
            x: 1.5,
            y: 1.5,
            angle: 0,
            fov: Math.PI / 3,
            speed: 0.07,
            turnSpeed: 0.05,
            hasStarted: false
        };
        
        // 简化的迷宫生成算法
        function generateMaze() {
            // 初始化迷宫，1表示墙，0表示路，2表示入口/出口
            maze = [];
            for (let y = 0; y < mazeSize; y++) {
                maze[y] = [];
                for (let x = 0; x < mazeSize; x++) {
                    // 创建边界墙
                    if (x === 0 || y === 0 || x === mazeSize - 1 || y === mazeSize - 1) {
                        maze[y][x] = 1;
                    } else {
                        maze[y][x] = 0;
                    }
                }
            }
            
            // 创建简单但有效的迷宫路径
            const paths = [
                // 水平通道
                {x: 1, y: 1}, {x: 2, y: 1}, {x: 3, y: 1}, {x: 4, y: 1}, {x: 5, y: 1},
                {x: 1, y: 3}, {x: 2, y: 3}, {x: 3, y: 3}, {x: 4, y: 3}, {x: 5, y: 3},
                {x: 1, y: 5}, {x: 2, y: 5}, {x: 3, y: 5}, {x: 4, y: 5}, {x: 5, y: 5},
                // 垂直通道
                {x: 1, y: 2}, {x: 1, y: 4},
                {x: 3, y: 2}, {x: 3, y: 4},
                {x: 5, y: 2}, {x: 5, y: 4}
            ];
            
            // 清除路径
            paths.forEach(path => {
                if (path.y >= 0 && path.y < mazeSize && path.x >= 0 && path.x < mazeSize) {
                    maze[path.y][path.x] = 0;
                }
            });
            
            // 添加一些随机墙增加难度
            const walls = [
                {x: 2, y: 2}, {x: 4, y: 2},
                {x: 2, y: 4}, {x: 4, y: 4}
            ];
            
            walls.forEach(wall => {
                if (wall.y >= 0 && wall.y < mazeSize && wall.x >= 0 && wall.x < mazeSize) {
                    maze[wall.y][wall.x] = 1;
                }
            });
            
            // 设置入口和出口（使用相同颜色）
            maze[1][0] = 2; // 入口
            maze[mazeSize - 2][mazeSize - 1] = 2; // 出口
            
            // 重置玩家位置
            player.x = 1.5;
            player.y = 1.5;
            player.angle = 0;
            player.hasStarted = false;
            
            // 显示开始消息
            startMessage.style.display = 'block';
            winMessage.style.display = 'none';
            
            updateUI();
        }
        
        // 优化的射线投射函数
        function castRay(angle) {
            const rayDirX = Math.cos(angle);
            const rayDirY = Math.sin(angle);
            
            let rayX = player.x;
            let rayY = player.y;
            let distance = 0;
            let hit = false;
            let side = 0;
            let cellType = 0;
            
            // 限制最大距离以提高性能
            const maxDistance = 12;
            
            while (!hit && distance < maxDistance) {
                rayX += rayDirX * 0.05; // 减小步长提高精度
                rayY += rayDirY * 0.05;
                distance += 0.05;
                
                const mapX = Math.floor(rayX);
                const mapY = Math.floor(rayY);
                
                if (mapX < 0 || mapX >= mazeSize || mapY < 0 || mapY >= mazeSize) {
                    hit = true;
                } else if (maze[mapY][mapX] !== 0) {
                    hit = true;
                    side = Math.abs(rayDirX) > Math.abs(rayDirY) ? 0 : 1;
                    cellType = maze[mapY][mapX];
                }
            }
            
            return { distance: Math.max(0.1, distance), side, cellType };
        }
        
        // 优化的3D渲染
        function render3D() {
            const width = canvas.width;
            const height = canvas.height;
            
            // 清空画布
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // 绘制天空和地面
            ctx.fillStyle = '#2a4b6b';
            ctx.fillRect(0, 0, width, height / 2);
            ctx.fillStyle = '#3a2f1d';
            ctx.fillRect(0, height / 2, width, height / 2);
            
            // 自适应射线数量基于屏幕宽度
            const rayCount = Math.min(80, Math.floor(width / 4));
            const step = width / rayCount;
            
            for (let i = 0; i < rayCount; i++) {
                const x = i * step;
                const cameraX = 2 * i / rayCount - 1;
                const rayAngle = player.angle + player.fov / 2 * cameraX;
                
                const hit = castRay(rayAngle);
                // 修正鱼眼效果
                const distance = hit.distance * Math.cos(rayAngle - player.angle);
                const wallHeight = Math.min(height / distance, height);
                
                // 根据单元格类型和距离选择颜色
                let wallColor;
                if (hit.cellType === 2) {
                    // 入口/出口 - 绿色
                    wallColor = distance > 5 ? '#0a0' : '#0f0';
                } else {
                    // 普通墙 - 根据距离和面选择颜色
                    if (hit.side === 0) {
                        wallColor = distance > 5 ? '#733' : '#a44';
                    } else {
                        wallColor = distance > 5 ? '#337' : '#44a';
                    }
                }
                
                const wallTop = (height - wallHeight) / 2;
                ctx.fillStyle = wallColor;
                ctx.fillRect(x, wallTop, step + 1, wallHeight); // +1 避免间隙
                
                // 距离阴影
                const shadowIntensity = Math.min(0.7, distance / 10);
                ctx.fillStyle = `rgba(0, 0, 0, ${shadowIntensity})`;
                ctx.fillRect(x, wallTop, step + 1, wallHeight);
            }
            
            renderMinimap();
            updateFPS();
        }
        
        // 渲染迷你地图
        function renderMinimap() {
            const size = minimapCanvas.width;
            const cellSize = size / mazeSize;
            
            // 清空迷你地图
            minimapCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            minimapCtx.fillRect(0, 0, size, size);
            
            // 绘制迷宫
            for (let y = 0; y < mazeSize; y++) {
                for (let x = 0; x < mazeSize; x++) {
                    if (maze[y][x] === 1) {
                        minimapCtx.fillStyle = '#000'; // 墙
                    } else if (maze[y][x] === 2) {
                        minimapCtx.fillStyle = '#0a0'; // 入口/出口
                    } else {
                        minimapCtx.fillStyle = '#fff'; // 路
                    }
                    minimapCtx.fillRect(x * cellSize, y * cellSize, cellSize - 1, cellSize - 1);
                }
            }
            
            // 绘制玩家
            const playerX = player.x * cellSize;
            const playerY = player.y * cellSize;
            
            minimapCtx.fillStyle = '#f00';
            minimapCtx.beginPath();
            minimapCtx.arc(playerX, playerY, cellSize / 3, 0, Math.PI * 2);
            minimapCtx.fill();
            
            // 绘制方向
            minimapCtx.strokeStyle = '#f00';
            minimapCtx.beginPath();
            minimapCtx.moveTo(playerX, playerY);
            minimapCtx.lineTo(
                playerX + Math.cos(player.angle) * cellSize * 1.5,
                playerY + Math.sin(player.angle) * cellSize * 1.5
            );
            minimapCtx.stroke();
        }
        
        // 移动玩家
        function movePlayer(dx, dy) {
            if (!player.hasStarted) {
                player.hasStarted = true;
                startMessage.style.display = 'none';
            }
            
            const newX = player.x + dx;
            const newY = player.y + dy;
            
            // 碰撞检测
            if (maze[Math.floor(newY)] && maze[Math.floor(newY)][Math.floor(newX)] !== 1) {
                player.x = newX;
                player.y = newY;
                updateUI();
                
                // 检查是否到达出口
                if (Math.floor(player.x) === mazeSize - 1 && Math.floor(player.y) === mazeSize - 2) {
                    statusElement.innerHTML = '<span class="success">恭喜! 你已找到出口!</span>';
                    winMessage.style.display = 'block';
                    
                    // 3秒后自动刷新
                    setTimeout(() => {
                        generateMaze();
                    }, 3000);
                }
            }
        }
        
        // 更新UI
        function updateUI() {
            positionElement.textContent = `(${Math.floor(player.x)}, ${Math.floor(player.y)})`;
            
            // 更新方向显示
            const angle = player.angle;
            let direction = '北';
            let compassChar = 'N';
            
            if (angle > -Math.PI/4 && angle <= Math.PI/4) {
                direction = '东';
                compassChar = 'E';
            } else if (angle > Math.PI/4 && angle <= 3*Math.PI/4) {
                direction = '南';
                compassChar = 'S';
            } else if (angle > 3*Math.PI/4 || angle <= -3*Math.PI/4) {
                direction = '西';
                compassChar = 'W';
            }
            
            directionElement.textContent = direction;
            compassElement.textContent = compassChar;
        }
        
        // 更新FPS显示
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            
            if (now >= lastTime + 1000) {
                fps = Math.round((frameCount * 1000) / (now - lastTime));
                fpsElement.textContent = fps;
                frameCount = 0;
                lastTime = now;
            }
        }
        
        // 触摸控制
        function setupTouchControls() {
            const buttons = {
                'btn-up': () => movePlayer(Math.cos(player.angle) * player.speed, Math.sin(player.angle) * player.speed),
                'btn-down': () => movePlayer(-Math.cos(player.angle) * player.speed, -Math.sin(player.angle) * player.speed),
                'btn-left': () => movePlayer(Math.cos(player.angle - Math.PI/2) * player.speed, Math.sin(player.angle - Math.PI/2) * player.speed),
                'btn-right': () => movePlayer(Math.cos(player.angle + Math.PI/2) * player.speed, Math.sin(player.angle + Math.PI/2) * player.speed),
                'btn-turn-left': () => {
                    if (!player.hasStarted) {
                        player.hasStarted = true;
                        startMessage.style.display = 'none';
                    }
                    player.angle -= player.turnSpeed;
                },
                'btn-turn-right': () => {
                    if (!player.hasStarted) {
                        player.hasStarted = true;
                        startMessage.style.display = 'none';
                    }
                    player.angle += player.turnSpeed;
                }
            };
            
            Object.keys(buttons).forEach(btnId => {
                const btn = document.getElementById(btnId);
                let interval;
                
                const startAction = () => {
                    buttons[btnId]();
                    interval = setInterval(buttons[btnId], 100);
                };
                
                const endAction = () => {
                    clearInterval(interval);
                };
                
                // 触摸事件
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startAction();
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    endAction();
                });
                
                btn.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    endAction();
                });
                
                // 鼠标事件（备用）
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startAction();
                });
                
                btn.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    endAction();
                });
                
                btn.addEventListener('mouseleave', (e) => {
                    e.preventDefault();
                    endAction();
                });
                
                // 防止上下文菜单
                btn.addEventListener('contextmenu', (e) => e.preventDefault());
            });
        }
        
        // 键盘控制（备用）
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (e.key.toLowerCase() === 'r') generateMaze();
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        // 游戏主循环
        function gameLoop() {
            // 处理键盘输入
            if (keys['w'] || keys['arrowup']) {
                if (!player.hasStarted) {
                    player.hasStarted = true;
                    startMessage.style.display = 'none';
                }
                movePlayer(Math.cos(player.angle) * player.speed, Math.sin(player.angle) * player.speed);
            }
            if (keys['s'] || keys['arrowdown']) {
                if (!player.hasStarted) {
                    player.hasStarted = true;
                    startMessage.style.display = 'none';
                }
                movePlayer(-Math.cos(player.angle) * player.speed, -Math.sin(player.angle) * player.speed);
            }
            if (keys['a'] || keys['arrowleft']) {
                if (!player.hasStarted) {
                    player.hasStarted = true;
                    startMessage.style.display = 'none';
                }
                player.angle -= player.turnSpeed;
            }
            if (keys['d'] || keys['arrowright']) {
                if (!player.hasStarted) {
                    player.hasStarted = true;
                    startMessage.style.display = 'none';
                }
                player.angle += player.turnSpeed;
            }
            
            render3D();
            requestAnimationFrame(gameLoop);
        }
        
        // 初始化游戏
        function init() {
            generateMaze();
            setupTouchControls();
            gameLoop();
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
