<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>æ‰«é›·æ¸¸æˆ</title>
<style id="dynamic-styles"></style>
</head>
<body>
<div id="app"></div>

<script>
// ==================== é…ç½®åŒºåŸŸ ====================
// 1. æ¸¸æˆé…ç½®
const GAME_CONFIG = {
    levels: {
        easy: { name: 'åˆçº§', rows: 8, cols: 8, mines: 10 },
        mid: { name: 'ä¸­çº§', rows: 12, cols: 12, mines: 25 },
        hard: { name: 'é«˜çº§', rows: 16, cols: 16, mines: 45 }
    },
    defaultLevel: 'easy',
    cellSize: 32,
    colors: {
        numbers: ['', '#1e88e5', '#43a047', '#e53935', '#8e24aa', '#fb8c00', '#00acc1', '#d81b60', '#fdd835'],
        background: '#1a1f2e',
        panel: 'rgba(255,255,255,0.08)',
        cellClosed: '#3a4556',
        cellOpen: '#2a3441',
        mine: '#e74c3c',
        flag: '#f39c12'
    },
    emojis: {
        smile: 'ğŸ™‚',
        dead: 'ğŸ˜µ',
        win: 'ğŸ˜',
        mine: 'ğŸ’£',
        flag: 'ğŸš©'
    }
};

// 2. UIæ¨¡æ¿é…ç½®
const UI_TEMPLATES = {
    app: `
        <div class="game-container">
            <div class="game-header">
                <h1 class="game-title">æ‰«é›·æ¸¸æˆ</h1>
                <div class="game-stats">
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ’£</span>
                        <span class="stat-value" id="mine-count">10</span>
                    </div>
                    <div class="smile-btn" id="smile-btn">${GAME_CONFIG.emojis.smile}</div>
                    <div class="stat-item">
                        <span class="stat-icon">â±ï¸</span>
                        <span class="stat-value" id="timer">0</span>
                    </div>
                </div>
                <div class="record-display">
                    <span>æœ€ä½³è®°å½•ï¼š</span>
                    <span id="record">--</span>
                </div>
            </div>
            
            <div class="game-controls">
                <button class="btn btn-primary" id="restart-btn">é‡æ–°å¼€å§‹</button>
                <button class="btn btn-secondary" id="new-game-btn">æ–°æ¸¸æˆ</button>
                <div class="level-selector">
                    <label>éš¾åº¦ï¼š</label>
                    <select id="level-select">
                        <option value="easy">åˆçº§ 8Ã—8 10é›·</option>
                        <option value="mid">ä¸­çº§ 12Ã—12 25é›·</option>
                        <option value="hard">é«˜çº§ 16Ã—16 45é›·</option>
                    </select>
                </div>
            </div>
            
            <div class="game-board-container">
                <div class="game-board" id="game-board"></div>
            </div>
        </div>
    `,
    cell: '<div class="cell" data-r="{r}" data-c="{c}"></div>'
};

// 3. CSSæ ·å¼é…ç½®
const CSS_STYLES = `
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        color: #fff;
    }
    
    .game-container {
        background: ${GAME_CONFIG.colors.background};
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        max-width: 95vw;
        max-height: 90vh;
        overflow-y: auto;
        backdrop-filter: blur(10px);
    }
    
    .game-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .game-title {
        font-size: 28px;
        margin-bottom: 15px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .game-stats {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 10px;
        gap: 20px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: ${GAME_CONFIG.colors.panel};
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
    }
    
    .stat-icon {
        font-size: 20px;
    }
    
    .smile-btn {
        font-size: 40px;
        background: ${GAME_CONFIG.colors.cellClosed};
        border: 3px solid #4a5568;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
    }
    
    .smile-btn:hover {
        transform: scale(1.1);
        background: #4a5568;
    }
    
    .smile-btn:active {
        transform: scale(0.95);
    }
    
    .record-display {
        font-size: 14px;
        color: #fbbf24;
        margin-top: 10px;
    }
    
    .game-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: ${GAME_CONFIG.colors.panel};
        color: white;
    }
    
    .btn-secondary:hover {
        background: rgba(255,255,255,0.15);
    }
    
    .level-selector {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .level-selector select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.2);
        background: ${GAME_CONFIG.colors.panel};
        color: white;
        font-size: 14px;
        cursor: pointer;
    }
    
    .level-selector option {
        background: ${GAME_CONFIG.colors.background};
    }
    
    .game-board-container {
        display: flex;
        justify-content: center;
        overflow-x: auto;
        padding: 10px;
    }
    
    .game-board {
        display: grid;
        gap: 2px;
        background: #1a2332;
        padding: 8px;
        border-radius: 10px;
    }
    
    .cell {
        width: ${GAME_CONFIG.cellSize}px;
        height: ${GAME_CONFIG.cellSize}px;
        background: ${GAME_CONFIG.colors.cellClosed};
        border: 2px solid #4a5568;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
    }
    
    .cell:hover:not(.open):not(.flag) {
        background: #4a5568;
        transform: scale(1.05);
    }
    
    .cell.open {
        background: ${GAME_CONFIG.colors.cellOpen};
        border: 1px solid #2a3441;
        cursor: default;
    }
    
    .cell.mine {
        background: ${GAME_CONFIG.colors.mine};
        animation: explode 0.5s ease-out;
    }
    
    .cell.flag {
        background: ${GAME_CONFIG.colors.flag};
        animation: plantFlag 0.3s ease-out;
    }
    
    @keyframes explode {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    @keyframes plantFlag {
        0% { transform: scale(0) rotate(0deg); }
        50% { transform: scale(1.2) rotate(10deg); }
        100% { transform: scale(1) rotate(0deg); }
    }
    
    @media (max-width: 768px) {
        .game-container {
            padding: 15px;
        }
        
        .game-title {
            font-size: 24px;
        }
        
        .game-stats {
            gap: 10px;
        }
        
        .stat-item {
            padding: 6px 12px;
            font-size: 16px;
        }
        
        .smile-btn {
            width: 50px;
            height: 50px;
            font-size: 32px;
        }
        
        .cell {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }
        
        .game-controls {
            flex-direction: column;
            gap: 8px;
        }
        
        .btn {
            width: 100%;
            max-width: 200px;
        }
    }
    
    @media (max-width: 480px) {
        .cell {
            width: 24px;
            height: 24px;
            font-size: 12px;
        }
    }
`;

// ==================== æ¸¸æˆé€»è¾‘ ====================
// 4. æ¸¸æˆçŠ¶æ€ç®¡ç†
class MinesweeperGame {
    constructor() {
        this.board = [];
        this.rows = 0;
        this.cols = 0;
        this.mines = 0;
        this.openCount = 0;
        this.flagCount = 0;
        this.gameOver = false;
        this.startTime = null;
        this.timerId = null;
        this.currentLevel = GAME_CONFIG.defaultLevel;
        
        this.init();
    }
    
    // 5. åˆå§‹åŒ–æ¸¸æˆ
    init() {
        this.applyStyles();
        this.renderUI();
        this.bindEvents();
        this.startNewGame();
    }
    
    // 6. åº”ç”¨æ ·å¼
    applyStyles() {
        document.getElementById('dynamic-styles').textContent = CSS_STYLES;
    }
    
    // 7. æ¸²æŸ“UI
    renderUI() {
        document.getElementById('app').innerHTML = UI_TEMPLATES.app;
    }
    
    // 8. ç»‘å®šäº‹ä»¶
    bindEvents() {
        document.getElementById('restart-btn').addEventListener('click', () => this.restartGame());
        document.getElementById('new-game-btn').addEventListener('click', () => this.startNewGame());
        document.getElementById('smile-btn').addEventListener('click', () => this.restartGame());
        document.getElementById('level-select').addEventListener('change', () => this.startNewGame());
    }
    
    // 9. å¼€å§‹æ–°æ¸¸æˆ
    startNewGame() {
        this.currentLevel = document.getElementById('level-select').value;
        const config = GAME_CONFIG.levels[this.currentLevel];
        this.rows = config.rows;
        this.cols = config.cols;
        this.mines = config.mines;
        
        this.generateBoard();
        this.resetGameState();
        this.renderBoard();
        this.updateDisplay();
        this.showRecord();
    }
    
    // 10. é‡æ–°å¼€å§‹æ¸¸æˆï¼ˆä¿ç•™é›·åŒºï¼‰
    restartGame() {
        this.resetGameState();
        this.renderBoard();
        this.updateDisplay();
    }
    
    // 11. ç”Ÿæˆæ¸¸æˆæ¿
    generateBoard() {
        // åˆå§‹åŒ–ç©ºæ¿
        this.board = Array(this.rows).fill().map(() => Array(this.cols).fill(0));
        
        // æ”¾ç½®åœ°é›·
        let minesToPlace = this.mines;
        while (minesToPlace > 0) {
            const r = Math.floor(Math.random() * this.rows);
            const c = Math.floor(Math.random() * this.cols);
            if (this.board[r][c] !== -1) {
                this.board[r][c] = -1;
                minesToPlace--;
            }
        }
        
        // è®¡ç®—æ•°å­—
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                if (this.board[r][c] === -1) continue;
                let count = 0;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const nr = r + dr;
                        const nc = c + dc;
                        if (nr >= 0 && nr < this.rows && nc >= 0 && nc < this.cols && this.board[nr][nc] === -1) {
                            count++;
                        }
                    }
                }
                this.board[r][c] = count;
            }
        }
    }
    
    // 12. é‡ç½®æ¸¸æˆçŠ¶æ€
    resetGameState() {
        this.openCount = 0;
        this.flagCount = 0;
        this.gameOver = false;
        this.stopTimer();
        this.startTime = null;
        document.getElementById('timer').textContent = '0';
        document.getElementById('smile-btn').textContent = GAME_CONFIG.emojis.smile;
    }
    
    // 13. æ¸²æŸ“æ¸¸æˆæ¿
    renderBoard() {
        const boardEl = document.getElementById('game-board');
        boardEl.innerHTML = '';
        boardEl.style.gridTemplateColumns = `repeat(${this.cols}, ${GAME_CONFIG.cellSize}px)`;
        
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                const cellEl = document.createElement('div');
                cellEl.className = 'cell';
                cellEl.dataset.r = r;
                cellEl.dataset.c = c;
                
                cellEl.addEventListener('click', () => this.openCell(r, c));
                cellEl.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.toggleFlag(r, c);
                });
                
                boardEl.appendChild(cellEl);
            }
        }
    }
    
    // 14. æ‰“å¼€å•å…ƒæ ¼
    openCell(r, c) {
        if (this.gameOver) return;
        
        const cellEl = this.getCellElement(r, c);
        if (!cellEl || cellEl.classList.contains('open') || cellEl.classList.contains('flag')) return;
        
        // å¼€å§‹è®¡æ—¶
        if (!this.startTime) {
            this.startTimer();
        }
        
        cellEl.classList.add('open');
        
        // è¸©åˆ°åœ°é›·
        if (this.board[r][c] === -1) {
            cellEl.classList.add('mine');
            cellEl.textContent = GAME_CONFIG.emojis.mine;
            this.endGame(false);
            return;
        }
        
        this.openCount++;
        const value = this.board[r][c];
        
        if (value > 0) {
            cellEl.textContent = value;
            cellEl.style.color = GAME_CONFIG.colors.numbers[value];
        } else {
            // è‡ªåŠ¨å±•å¼€ç©ºç™½åŒºåŸŸ
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (nr >= 0 && nr < this.rows && nc >= 0 && nc < this.cols) {
                        this.openCell(nr, nc);
                    }
                }
            }
        }
        
        this.checkWin();
    }
    
    // 15. åˆ‡æ¢æ——å¸œ
    toggleFlag(r, c) {
        if (this.gameOver) return;
        
        const cellEl = this.getCellElement(r, c);
        if (!cellEl || cellEl.classList.contains('open')) return;
        
        if (cellEl.classList.contains('flag')) {
            cellEl.classList.remove('flag');
            cellEl.textContent = '';
            this.flagCount--;
        } else {
            cellEl.classList.add('flag');
            cellEl.textContent = GAME_CONFIG.emojis.flag;
            this.flagCount++;
        }
        
        this.updateDisplay();
    }
    
    // 16. è·å–å•å…ƒæ ¼å…ƒç´ 
    getCellElement(r, c) {
        return document.querySelector(`[data-r="${r}"][data-c="${c}"]`);
    }
    
    // 17. å¼€å§‹è®¡æ—¶
    startTimer() {
        this.startTime = Date.now();
        this.timerId = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            document.getElementById('timer').textContent = elapsed;
        }, 1000);
    }
    
    // 18. åœæ­¢è®¡æ—¶
    stopTimer() {
        if (this.timerId) {
            clearInterval(this.timerId);
            this.timerId = null;
        }
    }
    
    // 19. æ›´æ–°æ˜¾ç¤º
    updateDisplay() {
        document.getElementById('mine-count').textContent = this.mines - this.flagCount;
    }
    
    // 20. æ£€æŸ¥èƒœåˆ©
    checkWin() {
        if (this.openCount === this.rows * this.cols - this.mines) {
            this.endGame(true);
        }
    }
    
    // 21. æ¸¸æˆç»“æŸ
    endGame(isWin) {
        this.gameOver = true;
        this.stopTimer();
        
        if (isWin) {
            document.getElementById('smile-btn').textContent = GAME_CONFIG.emojis.win;
            const time = parseInt(document.getElementById('timer').textContent);
            
            if (this.saveRecord(time)) {
                setTimeout(() => alert(`ğŸ‰ æ­å–œï¼æ–°çºªå½•ï¼š${time} ç§’ï¼`), 100);
            } else {
                setTimeout(() => alert('ğŸ‰ æ­å–œä½ ï¼Œæ’é›·æˆåŠŸï¼'), 100);
            }
        } else {
            document.getElementById('smile-btn').textContent = GAME_CONFIG.emojis.dead;
            this.revealAllMines();
            setTimeout(() => alert('ğŸ’¥ æ¸¸æˆç»“æŸï¼'), 100);
        }
    }
    
    // 22. æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
    revealAllMines() {
        for (let r = 0; r < this.rows; r++) {
            for (let c = 0; c < this.cols; c++) {
                if (this.board[r][c] === -1) {
                    const cellEl = this.getCellElement(r, c);
                    if (cellEl && !cellEl.classList.contains('flag')) {
                        cellEl.classList.add('open', 'mine');
                        cellEl.textContent = GAME_CONFIG.emojis.mine;
                    }
                }
            }
        }
    }
    
    // 23. ä¿å­˜è®°å½•
    saveRecord(time) {
        const key = `mineRecord_${this.currentLevel}`;
        const best = localStorage.getItem(key);
        
        if (!best || time < parseInt(best)) {
            localStorage.setItem(key, time);
            this.showRecord();
            return true;
        }
        return false;
    }
    
    // 24. æ˜¾ç¤ºè®°å½•
    showRecord() {
        const key = `mineRecord_${this.currentLevel}`;
        const record = localStorage.getItem(key);
        document.getElementById('record').textContent = record ? `${record} ç§’` : '--';
    }
}

// ==================== å¯åŠ¨æ¸¸æˆ ====================
// 25. åˆå§‹åŒ–å¹¶å¯åŠ¨æ¸¸æˆ
document.addEventListener('DOMContentLoaded', () => {
    new MinesweeperGame();
});
</script>
</body>
</html>
